---
phase: 02-summoner-profiles
plan: 04
type: execute
wave: 2
depends_on: ["02-01", "02-02"]
files_modified:
  - Transcendence.Service.Core/Services/RiotApi/DTOs/MatchHistoryResponse.cs
  - Transcendence.Service.Core/Services/Analysis/Models/StatsModels.cs
  - Transcendence.WebAPI/Models/Stats/SummonerStatsDtos.cs
autonomous: true

must_haves:
  truths:
    - "Match history includes items and runes for each match"
    - "Match summaries show summoner spells used"
    - "Items returned as array of 7 item IDs (including trinket slot)"
  artifacts:
    - path: "Transcendence.Service.Core/Services/Analysis/Models/StatsModels.cs"
      provides: "RecentMatchSummary with items/runes/spells"
      contains: "Items"
    - path: "Transcendence.Service.Core/Services/Analysis/Implementations/SummonerStatsService.cs"
      provides: "Query includes items and runes"
      contains: "Include.*Items"
  key_links:
    - from: "RecentMatchSummary"
      to: "MatchParticipantItem"
      via: "Items property mapping"
      pattern: "Items.*Select"
---

<objective>
Enhance match history summaries with items, runes, and summoner spells.

Purpose: PROF-02 requires "full stats" including items and runes. Current RecentMatchSummary only returns basic KDA/CS. Clients need loadout data to render proper match cards (like op.gg shows items/runes per match in history).

Output: Enhanced GET /api/summoners/{id}/matches/recent returns items, runes, and spells per match.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-summoner-profiles/02-01-PLAN.md

@Transcendence.Service.Core/Services/Analysis/Models/StatsModels.cs
@Transcendence.Service.Core/Services/Analysis/Implementations/SummonerStatsService.cs
@Transcendence.Data/Models/LoL/Match/MatchParticipantItem.cs
@Transcendence.Data/Models/LoL/Match/MatchParticipantRune.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend RecentMatchSummary with loadout data</name>
  <files>Transcendence.Service.Core/Services/Analysis/Models/StatsModels.cs</files>
  <action>
Update RecentMatchSummary record to include loadout data:

```csharp
public record RecentMatchSummary(
    string MatchId,
    long MatchDate,
    int DurationSeconds,
    string QueueType,
    bool Win,
    int ChampionId,
    string? TeamPosition,
    int Kills,
    int Deaths,
    int Assists,
    int VisionScore,
    int DamageToChamps,
    double CsPerMin,
    // New loadout fields
    int SummonerSpell1Id,
    int SummonerSpell2Id,
    IReadOnlyList<int> Items,  // 7 item IDs (6 items + trinket), 0 for empty slots
    MatchRuneSummary Runes
);
```

Add MatchRuneSummary record:
```csharp
public record MatchRuneSummary(
    int PrimaryStyleId,
    int SubStyleId,
    int KeystoneId  // First rune in primary tree (the keystone)
);
```

This provides enough rune data to show the keystone icon in match cards. Full rune details available via match detail endpoint.
  </action>
  <verify>dotnet build Transcendence.Service.Core</verify>
  <done>RecentMatchSummary includes SummonerSpells, Items array, and MatchRuneSummary</done>
</task>

<task type="auto">
  <name>Task 2: Update GetRecentMatchesAsync to fetch loadout data</name>
  <files>Transcendence.Service.Core/Services/Analysis/Implementations/SummonerStatsService.cs</files>
  <action>
Modify GetRecentMatchesAsync (or ComputeRecentMatchesAsync if already extracted for caching) to include loadout data:

1. The current query uses a projection that can't include navigation properties directly. Need to restructure:

```csharp
// First, get participant IDs with match data
var participantData = await query
    .Skip((page - 1) * pageSize)
    .Take(pageSize)
    .Select(mp => new
    {
        mp.Id,
        mp.Match.MatchId,
        mp.Match.MatchDate,
        mp.Match.Duration,
        mp.Match.QueueType,
        mp.Win,
        mp.ChampionId,
        mp.TeamPosition,
        mp.Kills,
        mp.Deaths,
        mp.Assists,
        mp.VisionScore,
        mp.TotalDamageDealtToChampions,
        mp.TotalMinionsKilled,
        mp.NeutralMinionsKilled,
        mp.SummonerSpell1Id,
        mp.SummonerSpell2Id
    })
    .ToListAsync(ct);

// Get items and runes for these participants
var participantIds = participantData.Select(p => p.Id).ToList();

var itemsByParticipant = await db.Set<MatchParticipantItem>()
    .Where(i => participantIds.Contains(i.MatchParticipantId))
    .GroupBy(i => i.MatchParticipantId)
    .Select(g => new { ParticipantId = g.Key, Items = g.OrderBy(i => i.Slot).Select(i => i.ItemId).ToList() })
    .ToDictionaryAsync(x => x.ParticipantId, x => x.Items, ct);

var runesByParticipant = await db.Set<MatchParticipantRune>()
    .Where(r => participantIds.Contains(r.MatchParticipantId))
    .GroupBy(r => r.MatchParticipantId)
    .Select(g => new
    {
        ParticipantId = g.Key,
        PrimaryStyleId = g.Where(r => r.IsPrimaryTree).Select(r => r.StyleId).FirstOrDefault(),
        SubStyleId = g.Where(r => !r.IsPrimaryTree).Select(r => r.StyleId).FirstOrDefault(),
        KeystoneId = g.Where(r => r.IsPrimaryTree).OrderBy(r => r.RuneSlot).Select(r => r.RuneId).FirstOrDefault()
    })
    .ToDictionaryAsync(x => x.ParticipantId, ct);

// Map to final DTOs
var items = participantData.Select(p =>
{
    var itemList = itemsByParticipant.GetValueOrDefault(p.Id) ?? new List<int>();
    // Ensure 7 slots (pad with 0s if needed)
    while (itemList.Count < 7) itemList.Add(0);

    var runes = runesByParticipant.GetValueOrDefault(p.Id);
    var runeSummary = runes != null
        ? new MatchRuneSummary(runes.PrimaryStyleId, runes.SubStyleId, runes.KeystoneId)
        : new MatchRuneSummary(0, 0, 0);

    return new RecentMatchSummary(
        p.MatchId!,
        p.MatchDate,
        p.Duration,
        p.QueueType!,
        p.Win,
        p.ChampionId,
        p.TeamPosition,
        p.Kills,
        p.Deaths,
        p.Assists,
        p.VisionScore,
        p.TotalDamageDealtToChampions,
        p.Duration > 0 ? (p.TotalMinionsKilled + p.NeutralMinionsKilled) / (p.Duration / 60.0) : 0.0,
        p.SummonerSpell1Id,
        p.SummonerSpell2Id,
        itemList,
        runeSummary
    );
}).ToList();
```

This batches the queries (1 for participants, 1 for items, 1 for runes) instead of N+1.
  </action>
  <verify>dotnet build Transcendence.Service.Core</verify>
  <done>GetRecentMatchesAsync returns loadout data with efficient batched queries</done>
</task>

<task type="auto">
  <name>Task 3: Update controller DTOs for loadout data</name>
  <files>Transcendence.WebAPI/Models/Stats/SummonerStatsDtos.cs</files>
  <action>
Update RecentMatchSummaryDto to include loadout fields:

```csharp
public record RecentMatchSummaryDto(
    string MatchId,
    long MatchDate,
    int DurationSeconds,
    string QueueType,
    bool Win,
    int ChampionId,
    string? TeamPosition,
    int Kills,
    int Deaths,
    int Assists,
    int VisionScore,
    int DamageToChamps,
    double CsPerMin,
    // New loadout fields
    int SummonerSpell1Id,
    int SummonerSpell2Id,
    IReadOnlyList<int> Items,
    MatchRuneSummaryDto Runes
);

public record MatchRuneSummaryDto(
    int PrimaryStyleId,
    int SubStyleId,
    int KeystoneId
);
```

Update the controller mapping in SummonerStatsController.GetRecentMatches:
```csharp
new RecentMatchSummaryDto(
    m.MatchId,
    m.MatchDate,
    m.DurationSeconds,
    m.QueueType,
    m.Win,
    m.ChampionId,
    m.TeamPosition,
    m.Kills,
    m.Deaths,
    m.Assists,
    m.VisionScore,
    m.DamageToChamps,
    m.CsPerMin,
    m.SummonerSpell1Id,
    m.SummonerSpell2Id,
    m.Items,
    new MatchRuneSummaryDto(m.Runes.PrimaryStyleId, m.Runes.SubStyleId, m.Runes.KeystoneId)
)
```
  </action>
  <verify>dotnet build Transcendence.WebAPI</verify>
  <done>Match history endpoint returns loadout data (items, runes, spells)</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `dotnet build Transcendence.sln` succeeds without errors
- [ ] RecentMatchSummary includes items array (7 slots)
- [ ] RecentMatchSummary includes rune summary (keystone + styles)
- [ ] RecentMatchSummary includes summoner spell IDs
- [ ] Queries batched efficiently (not N+1)
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Match history shows loadout data per match
- Query performance acceptable (batched fetches)
</success_criteria>

<output>
After completion, create `.planning/phases/02-summoner-profiles/02-04-SUMMARY.md`
</output>
