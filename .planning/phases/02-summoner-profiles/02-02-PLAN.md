---
phase: 02-summoner-profiles
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - Transcendence.Service.Core/Services/RiotApi/DTOs/SummonerProfileResponse.cs
  - Transcendence.Service.Core/Services/Analysis/Models/StatsModels.cs
  - Transcendence.WebAPI/Controllers/SummonersController.cs
  - Transcendence.WebAPI/Models/Stats/SummonerStatsDtos.cs
autonomous: true

must_haves:
  truths:
    - "Profile lookup returns complete data in a single call"
    - "Response includes overview stats, top champions, and recent matches"
    - "Champion stats include champion names resolved from static data"
  artifacts:
    - path: "Transcendence.Service.Core/Services/RiotApi/DTOs/SummonerProfileResponse.cs"
      provides: "Complete profile response with stats and champion breakdown"
      contains: "RecentMatches"
    - path: "Transcendence.WebAPI/Controllers/SummonersController.cs"
      provides: "Profile endpoint returns complete data"
      contains: "OverviewStats"
  key_links:
    - from: "SummonersController.GetByRiotId"
      to: "ISummonerStatsService"
      via: "Controller calls stats service for overview/champions"
      pattern: "statsService"
    - from: "SummonerProfileResponse"
      to: "ChampionStat"
      via: "TopChampions property"
      pattern: "TopChampions"
---

<objective>
Expand profile response to include overview stats, top champions, and recent match summaries in a single API call.

Purpose: User context explicitly states "everything instantly - the complete picture in one call." Current profile only returns basic info + rank. Need to include performance data for the desktop app's main profile view.

Output: Enhanced GET /api/summoners/{region}/{name}/{tag} that returns profile + rank + overview stats + top 5 champions + last 10 matches.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-04-SUMMARY.md

@Transcendence.Service.Core/Services/RiotApi/DTOs/SummonerProfileResponse.cs
@Transcendence.Service.Core/Services/Analysis/Models/StatsModels.cs
@Transcendence.Service.Core/Services/Analysis/Implementations/SummonerStatsService.cs
@Transcendence.WebAPI/Controllers/SummonersController.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend SummonerProfileResponse with stats data</name>
  <files>Transcendence.Service.Core/Services/RiotApi/DTOs/SummonerProfileResponse.cs</files>
  <action>
Add new properties to SummonerProfileResponse:

```csharp
// Overview statistics (from all matches)
public ProfileOverviewStats? OverviewStats { get; set; }

// Top champions by games played
public List<ProfileChampionStat>? TopChampions { get; set; }

// Recent match summaries (last 10)
public List<ProfileRecentMatch>? RecentMatches { get; set; }
```

Create supporting DTOs in the same file:

**ProfileOverviewStats:**
- TotalMatches, Wins, Losses (int)
- WinRate (double - percentage)
- AvgKills, AvgDeaths, AvgAssists, KdaRatio (double)
- AvgCsPerMin, AvgVisionScore, AvgDamageToChamps (double)

**ProfileChampionStat:**
- ChampionId (int)
- ChampionName (string) - resolved from static data or "Unknown" if missing
- Games, Wins, Losses (int)
- WinRate, KdaRatio (double)

**ProfileRecentMatch:**
- MatchId (string)
- MatchDate (long - epoch ms)
- QueueType (string)
- Win (bool)
- ChampionId (int)
- ChampionName (string)
- Kills, Deaths, Assists (int)
- CsPerMin (double)

These are simplified DTOs for the profile response - full details available via match detail endpoint.
  </action>
  <verify>dotnet build Transcendence.Service.Core</verify>
  <done>SummonerProfileResponse extended with OverviewStats, TopChampions, RecentMatches properties</done>
</task>

<task type="auto">
  <name>Task 2: Update SummonersController to populate full profile</name>
  <files>Transcendence.WebAPI/Controllers/SummonersController.cs</files>
  <action>
Modify GetByRiotId endpoint to include stats data:

1. Inject ISummonerStatsService into controller constructor (add to existing dependencies)

2. After finding summoner, call stats service to get overview and champion data:
```csharp
var overviewTask = statsService.GetSummonerOverviewAsync(summoner.Id, 20, ct);
var championsTask = statsService.GetChampionStatsAsync(summoner.Id, 5, ct);
var recentTask = statsService.GetRecentMatchesAsync(summoner.Id, 1, 10, ct);
await Task.WhenAll(overviewTask, championsTask, recentTask);
```

3. Map results to ProfileOverviewStats, ProfileChampionStat, ProfileRecentMatch

4. For ChampionName resolution: Query static data if available, otherwise use "Champion {id}" placeholder. Create a simple helper method:
```csharp
private string ResolveChampionName(int championId)
{
    // Phase 3 will add proper static data service
    // For now, return placeholder that clients can resolve client-side
    return $"Champion {championId}";
}
```

5. Populate the response properties before returning

Note: The parallel Task.WhenAll ensures minimal latency by fetching all stats concurrently.
  </action>
  <verify>dotnet build Transcendence.WebAPI</verify>
  <done>Profile endpoint returns complete data with stats, champions, and recent matches</done>
</task>

<task type="auto">
  <name>Task 3: Add DataAge to stats portions of profile response</name>
  <files>Transcendence.Service.Core/Services/RiotApi/DTOs/SummonerProfileResponse.cs</files>
  <action>
Add data freshness tracking for the stats portion:

```csharp
// Data freshness for stats (based on most recent match)
public DataAgeMetadata? StatsAge { get; set; }
```

In the controller mapping, calculate StatsAge:
1. Get the most recent match date from RecentMatches
2. Create DataAgeMetadata with FetchedAt = most recent match date
3. This tells clients when the stats were last updated (based on newest match data)

If no matches exist, StatsAge can be null (indicating no stats available).

This maintains consistency with the ProfileAge/RankAge pattern established in Phase 1.
  </action>
  <verify>dotnet build Transcendence.sln</verify>
  <done>Profile response includes StatsAge metadata for data freshness transparency</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `dotnet build Transcendence.sln` succeeds without errors
- [ ] Profile response includes OverviewStats with win rate, KDA, averages
- [ ] Profile response includes TopChampions (top 5 by games played)
- [ ] Profile response includes RecentMatches (last 10 matches)
- [ ] Stats fetched in parallel using Task.WhenAll
- [ ] StatsAge metadata populated from most recent match
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Single API call returns complete profile with all stats data
- Response time remains acceptable (<500ms with caching from Phase 1)
</success_criteria>

<output>
After completion, create `.planning/phases/02-summoner-profiles/02-02-SUMMARY.md`
</output>
