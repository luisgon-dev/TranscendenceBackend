---
phase: 02-summoner-profiles
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - Transcendence.Service.Core/Services/RiotApi/DTOs/MatchDetailDto.cs
  - Transcendence.Service.Core/Services/Analysis/Models/StatsModels.cs
  - Transcendence.Service.Core/Services/Analysis/Interfaces/ISummonerStatsService.cs
  - Transcendence.Service.Core/Services/Analysis/Implementations/SummonerStatsService.cs
  - Transcendence.WebAPI/Controllers/SummonerStatsController.cs
  - Transcendence.WebAPI/Models/Stats/SummonerStatsDtos.cs
autonomous: true

must_haves:
  truths:
    - "Match history shows items, runes, and summoner spells for each game"
    - "Match history includes all 10 participants per match with their stats"
    - "Data includes gold earned, champion level, and full damage stats"
  artifacts:
    - path: "Transcendence.Service.Core/Services/RiotApi/DTOs/MatchDetailDto.cs"
      provides: "Full match detail DTO with all participants"
      min_lines: 50
    - path: "Transcendence.Service.Core/Services/Analysis/Implementations/SummonerStatsService.cs"
      provides: "GetMatchDetailAsync method for full match data"
      contains: "GetMatchDetailAsync"
  key_links:
    - from: "SummonerStatsController"
      to: "ISummonerStatsService.GetMatchDetailAsync"
      via: "Controller calls service method"
      pattern: "GetMatchDetailAsync"
    - from: "SummonerStatsService"
      to: "MatchParticipant.Items"
      via: "EF Include for items/runes"
      pattern: "Include.*Items"
---

<objective>
Add full match details endpoint with complete participant data (items, runes, spells, all stats).

Purpose: PROF-02 requires "full stats" per match - current endpoint returns summaries only. Desktop and web clients need the complete picture for match analysis screens.

Output: New endpoint GET /api/summoners/{id}/matches/{matchId} returning all 10 participants with items, runes, spells, and detailed stats.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation/01-04-SUMMARY.md

@Transcendence.Service.Core/Services/Analysis/Models/StatsModels.cs
@Transcendence.Service.Core/Services/Analysis/Implementations/SummonerStatsService.cs
@Transcendence.WebAPI/Controllers/SummonerStatsController.cs
@Transcendence.Data/Models/LoL/Match/MatchParticipant.cs
@Transcendence.Data/Models/LoL/Match/MatchParticipantItem.cs
@Transcendence.Data/Models/LoL/Match/MatchParticipantRune.cs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create MatchDetailDto with full participant data</name>
  <files>Transcendence.Service.Core/Services/RiotApi/DTOs/MatchDetailDto.cs</files>
  <action>
Create MatchDetailDto record in the DTOs folder with:

**MatchDetailDto:**
- MatchId (string)
- MatchDate (long - epoch ms)
- Duration (int - seconds)
- QueueType (string)
- Patch (string)
- Participants (List of ParticipantDetailDto)

**ParticipantDetailDto:**
- Puuid, GameName, TagLine (summoner identity)
- TeamId (100 or 200)
- ChampionId (int)
- TeamPosition (string?)
- Win (bool)
- Kills, Deaths, Assists (int)
- ChampLevel, GoldEarned (int)
- TotalDamageDealtToChampions, VisionScore (int)
- TotalMinionsKilled, NeutralMinionsKilled (int)
- SummonerSpell1Id, SummonerSpell2Id (int)
- Items (List of int - item IDs, 7 slots including trinket)
- Runes (ParticipantRunesDto)

**ParticipantRunesDto:**
- PrimaryStyleId (int)
- SubStyleId (int)
- PrimarySelections (List of int - 4 rune IDs)
- SubSelections (List of int - 2 rune IDs)
- StatShards (List of int - 3 stat shard IDs)

Follow existing DTO conventions (records with init properties, nullable where appropriate).
  </action>
  <verify>dotnet build Transcendence.Service.Core</verify>
  <done>MatchDetailDto, ParticipantDetailDto, and ParticipantRunesDto records compile without errors</done>
</task>

<task type="auto">
  <name>Task 2: Add GetMatchDetailAsync to SummonerStatsService</name>
  <files>
    Transcendence.Service.Core/Services/Analysis/Interfaces/ISummonerStatsService.cs,
    Transcendence.Service.Core/Services/Analysis/Implementations/SummonerStatsService.cs
  </files>
  <action>
Add interface method to ISummonerStatsService:
```csharp
Task<MatchDetailDto?> GetMatchDetailAsync(string matchId, CancellationToken ct);
```

Implement in SummonerStatsService:
1. Query Match by MatchId with .Include(m => m.Participants) and ThenInclude for Items, Runes, and Summoner
2. Return null if match not found
3. Map Match and all Participants to MatchDetailDto
4. For Items: Query MatchParticipantItem where ParticipantId = participant.Id, order by Slot, return ItemIds as List
5. For Runes: Query MatchParticipantRune where ParticipantId = participant.Id, group by IsPrimaryTree to build primary/sub selections

Use AsNoTracking() for performance. Include Summoner navigation to get GameName/TagLine for each participant.
  </action>
  <verify>dotnet build Transcendence.Service.Core</verify>
  <done>GetMatchDetailAsync implemented and compiles</done>
</task>

<task type="auto">
  <name>Task 3: Add match detail endpoint to SummonerStatsController</name>
  <files>
    Transcendence.WebAPI/Controllers/SummonerStatsController.cs,
    Transcendence.WebAPI/Models/Stats/SummonerStatsDtos.cs
  </files>
  <action>
Add endpoint to SummonerStatsController:
```csharp
/// <summary>
/// Gets full match details including all participants with items, runes, and spells.
/// </summary>
[HttpGet("matches/{matchId}")]
[ProducesResponseType(typeof(MatchDetailDto), StatusCodes.Status200OK)]
[ProducesResponseType(StatusCodes.Status404NotFound)]
public async Task<IActionResult> GetMatchDetail(
    [FromRoute] Guid summonerId,
    [FromRoute] string matchId,
    CancellationToken ct = default)
```

Implementation:
1. Call statsService.GetMatchDetailAsync(matchId, ct)
2. If null, return NotFound()
3. Return Ok(result) - DTO is already in correct format

Note: summonerId in route provides context but match is fetched by matchId. This maintains RESTful nesting (/summoners/{id}/matches/{matchId}) and allows future authorization checks.
  </action>
  <verify>dotnet build Transcendence.WebAPI</verify>
  <done>GET /api/summoners/{summonerId}/matches/{matchId} endpoint returns full match details with all participants</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `dotnet build Transcendence.sln` succeeds without errors
- [ ] MatchDetailDto includes all participant data (items, runes, spells, stats)
- [ ] GetMatchDetailAsync queries with proper includes for performance
- [ ] Endpoint returns 404 for non-existent matches
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Match detail endpoint returns full participant data with items/runes/spells
- Query uses EF Include to avoid N+1 queries
</success_criteria>

<output>
After completion, create `.planning/phases/02-summoner-profiles/02-01-SUMMARY.md`
</output>
